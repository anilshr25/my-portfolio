name: Deploy with mTLS healthcheck

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Decode mTLS certificates
        run: |
          echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURyakNDQVpZQ0ZHYUJMZ0hsSmdLbXN0V0kxSjJYdGZpKzB4TDdNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1BOHgKRFRBTEJnTlZCQU1NQkUxNVEwRXdIaGNOTWpVd05qSXhNVGN3TnpVd1doY05Nall3TmpJeE1UY3dOelV3V2pBWQpNUll3RkFZRFZRUUREQTFuYVhSb2RXSXRZMnhwWlc1ME1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBCk1JSUJDZ0tDQVFFQXVJbkJQbURmVGtDM2FPVlpubU94WkNzemN0R0VHSS9BTGN0RFFYa0Q4ekZUOU5LZUdJb1cKbUNxekRhRXZjQWorRnlEd1IzYjZNVDhaeWxrRUdKRlRrdUo4OEJiaHVjU0tpOUhNVG9HaU9EMWtRellONmcyQwp6a0k2VTd1OGh2QWFFTHE2MWhYU1l1U0s0bVNHSldxWFBxZ2xGbVVmTFBZY0lZR2JnV1p0QmRrQzlqTDRGZVdRClA3RXhvSEdxSVJQaHMyZnlDc3J6aitWM2FhU0RDZ2FNdWlSb3VZQ05YMkN1RVlHSXBpYkJ2TkxlSVFnSElMMFoKYTl2NVZWQmJlUTFKZStIZm04VWNtMWJ4ZU9zWVg2NFVpeVAvcllHN3Zrd1Joa3VyaURmZnFjeUo5L2VMN3JvRwo3bWhWVHA4Q3JlcThXUUlhMlpjcjJYZTRLTDVBdmFDSXVRSURBUUFCTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElDCkFRQk5vc0lHNWI1T1lNV051WjF6UWZ4SVZmQXpLZjVxUi9TNnVscFB5U1NZTEo5TGQ2MDVEbFYveUJPREl0Vi8KRytHZGViRVd4cVF0TS9ERHJvK1hTdGx4T1pCWTNjVW1NdEFvZ3NhV0lKVnp5Nmh5ZllmczBhMURXcVhrZnlOMgpxVGozb0dqdTFObnZMNldWcUVYUXVvcmhMUmZaZHIyVGFtVTFaVVFLVjNmeFU2aHNpTWtOdTRVTHpYUW9DbFZzCnpkTVFBblRjb1hyVFJYV1hrSXFkTE1BVU4xTHQ1cHJQbDdSclBqMVU4aTN2Wm5Zc3FKTEk0WHBMbERQZjI5YXEKY2Z0RmVMRkNtSlV1RXhjTFN1d3U4TTlOMkY2NVRFa3dya2R4anVHd2xMM3Y3Zy9Zbk0vY1ViSkswL3pUTGtEVwpDMGJMUzZRVGpmK1kyZWlOT3c2U1BwdW9QN09XYkxMLzRmRmdpY1kyc1Z1QlhIOHloR2RlSlo0MkhxcmF2bVBWCjZyOXpkOVpIbzM2NEdHYXZEejZwOGJpMUk2NHoyTmc4QStSQ1FGTnlWYm5wZSsyYUs4SXhXa0JkZzVXVk9JRzcKMzJEZytoNHlLSEFkOEpGVVQzVGo5elJBNjJ0ZjFFaEN6ZUVXdG53RDl5YkR1bFU2TEZYblN6WGdlNHhodC9raQpoc0JhbGFSaUt4NEk2MzFpZHdQYU42MUZpNm5MbDAwdXdrYk92NVY2b1cyMTJyS0xBY3M2dXRGVlNGR2hXK1BlClROblJJYThzckFaOTRYdm9qWXBJajlpdk96czcyQ2VwcTRSY2V4N0tWWUNNRnJ0UDBjelNPV1VNdzhwbFBkazMKbXBXWGV6NjFiajdhM2hPdjFHMEliRFFmNnBPck5aVkFJd05CaGIvdWZNQWtJUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K" | base64 -d

      - name: Health check with mTLS (2s timeout)
        env:
          SERVER_IP: ${{ secrets.DEPLOY_SERVER_TWO }}
          PROTOCOL: https
        run: |
          echo "⏳ Checking $PROTOCOL://$SERVER_IP/healthcheck with mTLS"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --cert client.crt --key client.key --cacert ca.pem \
            --connect-timeout 2 --max-time 2 \
            "$PROTOCOL://$SERVER_IP/healthcheck")

          echo "↪ HTTP Status: $STATUS"

          if [ "$STATUS" = "200" ]; then
            echo "✅ Server $SERVER_IP is healthy."
          else
            echo "❌ Healthcheck failed with HTTP status $STATUS."
            exit 1
          fi
