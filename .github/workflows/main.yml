name: Deploy with mTLS healthcheck

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Decode mTLS certificates
        run: |
          printf "%s" "${{ secrets.CERT_PEM_B64 }}" | base64 -d > /tmp/client.crt
          printf "%s" "${{ secrets.KEY_PEM_B64 }}" | base64 -d > /tmp/client.key
          printf "%s" "${{ secrets.CA_PEM_B64 }}" | base64 -d > /tmp/ca.pem
          
      - name: Health check with mTLS (allow failure)
        env:
          SERVER_IP: ${{ secrets.DEPLOY_SERVER_TWO }}
          PROTOCOL: https
        run: |
          echo "‚è≥ Checking $PROTOCOL://$SERVER_IP/healthcheck with mTLS..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --cert client.crt --key client.key --cacert ca.pem \
            --connect-timeout 2 --max-time 3 \
            "$PROTOCOL://$SERVER_IP/healthcheck" || echo "curl_failed")
          if [ "$STATUS" = "curl_failed" ]; then
            echo "‚ö†Ô∏è Curl timed out or failed to connect (exit code 28). Server may be offline."
            echo "üü° Skipping health check failure and continuing deployment..."
          elif [ "$STATUS" = "200" ]; then
            echo "‚úÖ Server is healthy (HTTP 200)"
          else
            echo "‚ö†Ô∏è Server responded with HTTP $STATUS. Proceeding anyway..."
          fi



