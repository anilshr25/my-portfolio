name: Deploy with mTLS healthcheck

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Decode mTLS certificates
        run: |
          printf "%s" "${{ secrets.CERT_PEM_B64 }}" | base64 -d > /tmp/client.crt
          printf "%s" "${{ secrets.KEY_PEM_B64 }}" | base64 -d > /tmp/client.key
          printf "%s" "${{ secrets.CA_PEM_B64 }}" | base64 -d > /tmp/ca.pem
          
      - name: Health check with mTLS (2s timeout)
        env:
          SERVER_IP: ${{ secrets.DEPLOY_SERVER_TWO }}
          PROTOCOL: https
        run: |
          echo "⏳ Checking $PROTOCOL://$SERVER_IP/healthcheck with mTLS..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --cert client.crt --key client.key --cacert ca.pem \
            --connect-timeout 2 --max-time 3 \
            "$PROTOCOL://$SERVER_IP/healthcheck")
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "❌ Curl failed to connect (exit code $EXIT_CODE). Server may be offline or unreachable."
            exit 1
          fi
          
          if [ "$STATUS" = "200" ]; then
            echo "✅ Server is healthy (HTTP 200)"
          else
            echo "⚠️ Server responded with HTTP $STATUS"
            exit 1
          fi

