name: Deploy with mTLS healthcheck (single try)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Decode certificates
        run: |
          echo "${{ secrets.CERT_PEM_B64 }}" | base64 -d > client.crt
          echo "${{ secrets.KEY_PEM_B64 }}" | base64 -d > client.key
          echo "${{ secrets.CA_PEM_B64 }}" | base64 -d > ca.pem

      - name: Health check with mTLS (single attempt)
        env:
          SERVER_IP: 192.168.1.100
          PROTOCOL: https
        run: |
          echo "üîé Checking health of $PROTOCOL://$SERVER_IP/healthcheck"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --cert client.crt --key client.key --cacert ca.pem \
            --connect-timeout 3 --max-time 5 \
            "$PROTOCOL://$SERVER_IP/healthcheck")

          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Server $SERVER_IP is healthy."
          else
            echo "‚ùå Healthcheck failed with HTTP status $STATUS."
            exit 1
          fi
